var SkewT=function(t){var e=document.createElement("div");e.id="skewtbox",t.appendChild(e);var a=55,r=1050,n=100,s=[1e3,850,700,500,300,200,100],l=[950,900,800,750,650,600,550,450,400,350,250,150],p=15,i=!1,d=[30,10,20,10],o=700-d[0]-d[1],c=700-d[2]-d[3],u=Math.tan(a*(Math.PI/180)),f=d3.scale.linear().range([0,o]).domain([-45,50]),m=d3.scale.log().range([0,c]).domain([n,r]),h=(d3.scale.linear().range([0,300]).domain([0,150]),d3.scale.linear(),function(t){return 9*t/5+32}),y=function(t){return 3.281*t},g=function(t){return 2.2369362920544*t},x=function(t){return 1.943844492*t},v=function(t){return 3.6*t},w=d3.svg.axis().scale(f).tickSize(0,0).ticks(10).orient("bottom"),b=d3.svg.axis().scale(m).tickSize(0,0).tickValues(s).tickFormat(d3.format(".0d")).orient("left"),k=d3.svg.axis().scale(m).tickSize(5,0).tickValues(l).orient("left"),M=d3.select("div#skewtbox").append("svg").attr("width",o+d[0]+d[1]).attr("height",c+d[2]+d[3]).append("g").attr("transform","translate("+d[0]+","+d[3]+")"),A=(M.append("clipPath").attr("id","clipper").append("rect").attr("x",0).attr("y",0).attr("width",o).attr("height",c),M.append("g").attr("class","skewt")),z=M.append("g").attr("class","windbarb"),S=M.append("g").attr("class","skewtbg"),C=M.append("g").attr("class","tooltip"),E=function(){S.selectAll("templine").data(d3.range(-100,45,10)).enter().append("line").attr("x1",function(t){return f(t)-.5+(m(r)-m(100))/u}).attr("x2",function(t){return f(t)-.5}).attr("y1",0).attr("y2",c).attr("class",function(t){return 0==t?"tempzero":"gridline"}).attr("clip-path","url(#clipper)"),S.selectAll("pressureline").data(s).enter().append("line").attr("x1",0).attr("x2",o).attr("y1",function(t){return m(t)}).attr("y2",function(t){return m(t)}).attr("class","gridline");for(var t=d3.range(n,r+1,10),e=d3.range(-30,240,20),a=[],l=0;l<e.length;l++){for(var p=[],i=0;i<t.length;i++)p.push(e[l]);a.push(p)}var d=d3.svg.line().interpolate("linear").x(function(e,a){return f((273.15+e)/Math.pow(1e3/t[a],.286)-273.15)+(m(r)-m(t[a]))/u}).y(function(e,a){return m(t[a])});S.selectAll("dryadiabatline").data(a).enter().append("path").attr("class","gridline").attr("clip-path","url(#clipper)").attr("d",d),S.append("line").attr("x1",o-.5).attr("x2",o-.5).attr("y1",0).attr("y2",c).attr("class","gridline"),S.append("g").attr("class","x axis").attr("transform","translate(0,"+(c-.5)+")").call(w),S.append("g").attr("class","y axis").attr("transform","translate(-0.5,0)").call(b),S.append("g").attr("class","y axis ticks").attr("transform","translate(-0.5,0)").call(k)},F=function(){var t=d3.range(5,105,5),e=M.append("defs");t.forEach(function(t){var a=e.append("g").attr("id","barb"+t),r=Math.floor(t/50),n=Math.floor((t-50*r)/10),s=Math.floor((t-50*r-10*n)/5),l=p;a.append("line").attr("x1",0).attr("x2",0).attr("y1",0).attr("y2",p);for(var i=0;i<r;i++)a.append("polyline").attr("points","0,"+l+" -10,"+l+" 0,"+(l-4)).attr("class","flag"),l-=7;for(i=0;i<n;i++)a.append("line").attr("x1",0).attr("x2",-10).attr("y1",l).attr("y2",l+4),l-=3;for(i=0;i<s;i++)a.append("line").attr("x1",0).attr("x2",-5).attr("y1",l).attr("y2",l+2),l-=3})},P=function(t){var e=t.reverse();C.selectAll("*").remove();var a=4,n=a+5,s=d3.bisector(function(t){return t.press}).left,l=C.append("g").attr("class","focus tmpc").style("display","none");l.append("circle").attr("r",a),l.append("text").attr("x",n).attr("dy",".35em");var p=C.append("g").attr("class","focus dwpc").style("display","none");p.append("circle").attr("r",a),p.append("text").attr("x",-n).attr("text-anchor","end").attr("dy",".35em");var d=C.append("g").attr("class","focus").style("display","none");d.append("text").attr("x",0).attr("text-anchor","start").attr("dy",".35em");var x=C.append("g").attr("class","focus windspeed").style("display","none");x.append("text").attr("x",0).attr("text-anchor","start").attr("dy",".35em"),C.append("rect").attr("class","tooltipRegion").attr("width",o).attr("height",c).on("mouseover",function(){l.style("display",null),p.style("display",null),d.style("display",null),x.style("display",null)}).on("mouseout",function(){l.style("display","none"),p.style("display","none"),d.style("display","none"),x.style("display","none")}).on("mousemove",function(){var t=m.invert(d3.mouse(this)[1]),a=s(e,t,1,e.length-1),n=e[a-1],o=e[a],c=t-n.press>o.press-t?o:n,w=i?c.hght:y(c.hght),b=i?c.temp:h(c.temp),k=i?c.dwpt:h(c.dwpt),M=i?v(c.wspd):g(c.wspd),A=i?" m":" ft",z=i?"°C":"°F",S=i?" Km/h":" mph";l.attr("transform","translate("+(f(c.temp)+(m(r)-m(c.press))/u)+","+m(c.press)+")"),p.attr("transform","translate("+(f(c.dwpt)+(m(r)-m(c.press))/u)+","+m(c.press)+")"),d.attr("transform","translate(0,"+m(c.press)+")"),l.select("text").text(Math.round(b)+z),p.select("text").text(Math.round(k)+z),d.select("text").text("-- "+Math.round(w)+A),x.attr("transform","translate(555,"+m(c.press)+")"),x.select("text").text(Math.round(10*M)/10+S)})},R=function(t){var e=t.filter(function(t){return t.temp>-1e3&&t.dwpt>-1e3}),a=[e],s=d3.svg.line().interpolate("linear").x(function(t,e){return f(t.temp)+(m(r)-m(t.press))/u}).y(function(t,e){return m(t.press)}),l=d3.svg.line().interpolate("linear").x(function(t,e){return f(t.dwpt)+(m(r)-m(t.press))/u}).y(function(t,e){return m(t.press)});A.selectAll("templines").data(a).enter().append("path").attr("class",function(t,e){return e<10?"temp member":"temp mean"}).attr("clip-path","url(#clipper)").attr("d",s),A.selectAll("tempdewlines").data(a).enter().append("path").attr("class",function(t,e){return e<10?"dwpt member":"dwpt mean"}).attr("clip-path","url(#clipper)").attr("d",l);z.selectAll("use").remove();var p=e.filter(function(t){return t.wdir>=0&&t.wspd>=0&&t.press>=n});z.selectAll("barbs").data(p).enter().append("use").attr("xlink:href",function(t){return"#barb"+5*Math.round(x(t.wspd)/5)}).attr("transform",function(t,e){return"translate("+o+","+m(t.press)+") rotate("+(t.wdir+180)+")"});P(e)},V=function(t){A.selectAll("path").remove(),z.selectAll("use").remove(),M.select(".tooltipRegion").remove()};this.drawBackground=E,this.plot=R,this.clear=V,E(),F()};